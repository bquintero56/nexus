pipeline {
    agent { label 'WindowsALMTest' }

    options {
        timestamps()
    }

    stages {

        stage('Info JVM') {
            steps {
                bat '''
                echo ==== JAVA VERSION ====
                java -version

                echo ==== JAVA PROPERTIES ====
                java -XshowSettings:vm -version 2>&1 | findstr /R /C:"Max. Heap" /C:"Metaspace"
                '''
            }
        }

        stage('Stress CPU') {
            steps {
                bat '''
                echo ==== CPU STRESS ====
                for /L %%i in (1,1,4) do start /B cmd /C "for /L %%x in (1,1,500000000) do echo %%x > nul"
                timeout /T 60
                '''
            }
        }

        stage('Stress Memory (Java)') {
            steps {
                bat '''
                echo ==== JAVA MEMORY STRESS ====
                java -Xms32m -Xmx128m -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -version
                timeout /T 30
                '''
            }
        }

        stage('Workspace IO') {
            steps {
                bat '''
                echo ==== IO STRESS ====
                for /L %%i in (1,1,20) do (
                  echo Archivo %%i > test_%%i.txt
                )
                dir
                '''
            }
        }
    }

    post {
        always {
            bat 'echo ==== TEST FINALIZADO ===='
        }
    }
}





































<service>
  <id>JenkinsAgent-WindowsTest</id>
  <name>Jenkins Agent (WindowsTest)</name>
  <description>Jenkins inbound agent Windows (WebSocket estabilizado)</description>

  <executable>D:\JenkinsTestWindows\jdk-21.0.8\bin\java.exe</executable>

  <arguments>
    -Xms256m
    -Xmx768m
    -XX:MaxMetaspaceSize=256m
    -XX:+UseG1GC
    -Djava.awt.headless=true
    -Dfile.encoding=UTF-8
    -Dorg.jenkinsci.remoting.engine.PingThread.pingIntervalSeconds=60
    -Dorg.jenkinsci.remoting.engine.PingThread.timeoutSeconds=300
    -jar D:\JenkinsTestWindows\Jenkins\agent.jar
    -url https://ding.echonet
    -secret c79e82122f0d7a18cd
    -name WindowsALMTest
    -webSocket
    -workDir D:\JenkinsTestWindows\workspace
  </arguments>

  <log mode="roll-by-size">
    <sizeThreshold>10MB</sizeThreshold>
    <keepFiles>5</keepFiles>
  </log>

  <startmode>Automatic</startmode>

  <!-- Reinicio con backoff -->
  <onfailure action="restart" delay="60 sec"/>

</service>
